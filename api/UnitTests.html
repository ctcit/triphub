<html>
<style>
    td {
        vertical-align: top;
    }

    .messageDestination {
        background: lightgray
    }
</style>

<head>
    <title>Unit tests for API</title>
</head>

<body>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script>
        $(document).ready(function () {
            const testNames = Object.keys(window).filter(name => name.startsWith('test_'))

            for (const testName of testNames) {
                $(`
                <tr>
                    <td>${testName}<td>
                    <td>${testNames.indexOf(testName) + 1}/${testNames.length}<td>
                    <td id='${testName}'></td>
                </tr>`).appendTo($('#result'))
            }


            $('#start').click(async () => {
                try {
                    for (const testName of testNames) {
                        $('.messageDestination').removeClass('messageDestination')
                        $(`#${testName}`).addClass('messageDestination')
                        message('Started')
                        await window[testName]()
                        message('Success').css('color', 'green')
                    }
                } catch (e) {
                    message(`Failed ${e}`).css('color', 'red')
                }
            })
        })

        function GetDateString(date) {
            return `${date.getFullYear()}-${`${date.getMonth() + 1}`.padStart(2, '0')}-${`${date.getDate()}`.padStart(2, '0')}`
        }

        async function submit(method, url, data) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: `https://ctc.org.nz/triphub-alastair/api/api.php/${url}`,
                    type: method,
                    data: method == 'GET' || method == 'DELETE' ? null : JSON.stringify(data),
                    headers: { 'Api-Key': '7G0I3BSHPDXV69QWX1IWK4PR3WRJ6KAC', 'Api-Userid': 125 },
                    success: (data, status) => {
                        console.log(data)
                        resolve(data)
                    },
                    error: (jqXHR, textStatus, errorThrown) => {
                        const message = `${method} ${url} ${JSON.stringify(data)} ${textStatus} ${errorThrown}`
                        console.log(jqXHR)
                        console.log(message)
                        reject(message)
                    }
                })
            })
        }

        function message(msg) {
            return $('<div>').appendTo($('.messageDestination')).text(msg)
        }

        function messageHtml(html) {
            const id = `html${Math.random()}`.replace('.', '')
            message('').append($('<button>').text('\u00A0').click(e => $(`#${id}`).toggle()))
            message('').attr('id', id).html(html).hide()
        }

        function assertTrue(condition, msg) {
            if (!condition) {
                throw Error(`Testing Failed: ${msg || 'No message'}`)
            }
        }

        function assertEquals(a, b) {
            assertTrue(JSON.stringify(a) == JSON.stringify(b), `${JSON.stringify(a)} != ${JSON.stringify(b)}`)
        }

        function assertContains(haystack, needle) {
            assertTrue(haystack.indexOf(needle) >= 0, `${JSON.stringify(needle)} is not in ${JSON.stringify(haystack)}`)
        }

        let tripId = 0
        let nickId = 0
        let bruceId = 0
        let dougId = 0

        async function test_get_config() {
            const result = await submit('GET', 'config')

            assertEquals(result.length, 1)
            assertEquals(Object.keys(result[0]),
                ['showDebugUpdate', 'printLines', 'editRefreshInSec', 'calendarStartOfWeek', 'prerequisiteEquipment', 'prerequisiteSkills'])
        }

        async function test_get_logondetails() {
            await submit('GET', 'logondetails')
        }

        async function test_get_members() {
            const result = await submit('GET', 'members')
            assertTrue(result.length > 1)
            assertEquals(Object.keys(result[0]), ['id', 'name', 'email', 'phone', 'emergencyContactName', 'emergencyContactPhone', 'role', 'isMe', 'isMember'])
        }

        async function test_get_member() {
            const result = await submit('GET', 'members/125')
            assertEquals(result.length, 1)
            assertEquals(Object.keys(result[0]), ['id', 'name', 'email', 'phone', 'emergencyContactName', 'emergencyContactPhone', 'role', 'isMe', 'isMember'])
        }

        async function test_post_trip() {
            const trip = {
                title: 'test trip',
                openDate: GetDateString(new Date()),
                closeDate: GetDateString(new Date()),
                tripDate: GetDateString(new Date()),
                isLimited: true,
                maxParticipants: 2
            }

            await submit('POST', `trips/emails`)
            tripId = (await submit('POST', 'trips', trip))[0].id
            await submit('POST', `trips/${tripId}/participants`, { memberId: 125, name: 'Alastair Brown', isLeader: true })
        }

        async function test_approve() {
            await submit('POST', `trips/${tripId}`, { approval: 'Approved' })
            const trips = await submit('POST', `trips/emails`)
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
            assertContains(trips[0].email.subject, 'RE: test trip on ')
            assertContains(trips[0].email.subject, ' has just been Approved')
            assertContains(trips[0].email.html, 'This trip has just been <b>Approved</b> by ')
        }

        async function test_reject() {
            await submit('POST', `trips/${tripId}`, { approval: 'Rejected' })
            const trips = await submit('POST', `trips/emails`, {})
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
            assertContains(trips[0].email.subject, 'RE: test trip on ')
            assertContains(trips[0].email.subject, ' has changed from Approved to Rejected')
            assertContains(trips[0].email.html, 'This trip has just been changed from <b>Approved</b> to <b>Rejected</b> by ')
        }

        async function test_add_participants() {
            nickId = (await submit('POST', `trips/${tripId}/participants`, { memberId: 2218, name: 'Nick Edwards' }))[0].id
            bruceId = (await submit('POST', `trips/${tripId}/participants`, { memberId: 520, name: 'Bruce James' }))[0].id
            await submit('GET', `trips/${tripId}/html`)
            const history = await submit('GET', `trips/${tripId}/history`, {})
            const trip = await submit('GET', `trips/${tripId}`)
            const participants = await submit('GET', `trips/${tripId}/participants`)
            assertEquals(history.length, 8)
            assertEquals(trip[0].title, 'test trip')
            assertEquals(participants.length, 3)
        }

        async function test_email_initial() {
            const trips = await submit('POST', `trips/emails`, {})
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
        }

        async function test_email_after_participant_change() {
            await submit('POST', `trips/${tripId}/participants/${bruceId}`, { displayPriority: nickId - 0.5 })
            const history = await submit('GET', `trips/${tripId}/history`)
            const trips = await submit('POST', `trips/emails`, {})
            assertEquals(history.length, 10)
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
            assertContains(trips[0].email.html, '<b>Bruce James</b> has changed from <b>waitlisted</b> to <b>listed</b>')
            assertContains(trips[0].email.html, '<b>Nick Edwards</b> has changed from <b>listed</b> to <b>waitlisted</b>')
        }

        async function test_email_after_trip_change() {
            await submit('POST', `trips/${tripId}`, { isLimited: false })
            const history = await submit('GET', `trips/${tripId}/history`)
            assertEquals(history.length, 12)
            const trips = await submit('POST', `trips/emails`, {})
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
            assertContains(trips[0].email.html, '<b>Nick Edwards</b> has changed from <b>waitlisted</b> to <b>listed</b>')
        }

        async function test_email_after_signup() {
            dougId = (await submit('POST', `trips/${tripId}/participants`, { memberId: 432, name: 'Doug Forster' }))[0].id
            await submit('GET', `trips/${tripId}/history`)
            await submit('GET', `trips/${tripId}`)
            const trips = await submit('POST', `trips/emails`)
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
            assertContains(trips[0].email.html, '<b>Doug Forster</b> has signed up and is <b>listed</b>')
        }

        async function test_email_after_delete() {
            await submit('POST', `trips/${tripId}/participants/${bruceId}`, { isDeleted: true })
            const trips = await submit('POST', `trips/emails`, {})
            messageHtml(trips[0].email.html)
            assertEquals(trips.length, 1)
            assertContains(trips[0].email.html, '<b>Bruce James</b> has changed from <b>listed</b> to <b>removed</b>')
            assertEquals(trips[0].email.deletedRecipients.length, 1)
        }

        async function test_delete() {
            const trips = await submit('GET', 'trips')
            const testTrips = trips.filter(t => t.title == 'test trip')
            message(`deleting ${testTrips.length} trips`)

            for (const trip of testTrips) {
                await submit('DELETE', `trips/${trip.id}`)
            }
        }

    </script>
    <button id='start'>Start</button>
    <table id='result'></table>
</body>

</html>