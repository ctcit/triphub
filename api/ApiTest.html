<html>
    <title>API Test</title>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            $( document ).ready(function() {
                const params = new URLSearchParams(window.location.search);
                const method = params.get('METHOD')
                const path = params.get('BASEHREF') + '/' + params.get('PATH')
                const fields = JSON.parse(params.get('FIELDS'))
                const regex = /{\w+}/g

                $('#Header').html(method + ' ' + path)
                $('#Home').html("<a href='"+params.get('BASEHREF')+"'><i>(home)</i></a>")
                $('#Submit').html(method)
                $('#Input').html(params.get('INPUT'))
                $('#Output').html(params.get('OUTPUT'))
                $('#Description').html(params.get('DESCRIPTION'))

                path.replace(regex, function(key, id) {
                    $('#Fields').append($("<tr><td>"+key+"</td>"+
                                              "<td></td>"+
                                              "<td><input type='text' id='"+id+"'/></td></tr>"))
                });

                for (let field of fields) {
                    const input = field.type == 'text' ? "<textarea id='"+field.col+"'></textarea>" 
                                                       : "<input type='text' id='"+field.col+"'/>"
                    $('#Fields').append($("<tr><td>"+field.col+"</td>"+
                                              "<td><input type='checkbox' id='"+field.col+"_enabled'/></td>"+
                                              "<td>"+input+"</td>"+
                                              "<td>"+field.type+"</td>"+
                                              "<td>"+field.comment+"</td></tr>"))
                }

                $("#Submit").click(function(){
                    let data = {}
                    let submitpath = path.replace(regex, function(key, id) { return $("#"+id).val() });
                    for (let field of fields) {
                        if ($("#"+field.col+"_enabled").val())
                            data[field.col] = $("#"+field.col).val()
                    }
                    $.ajax({
                        url:submitpath + '?prettyprintjson=1',
                        type:method,
                        data:method == 'GET' || method == 'DELETE' ? null : JSON.stringify(data),
                        success:function(data,status){
                                $('#PrettyPrintJsonOutput').html(data);
                                $('.block').css('cursor', 'hand')
                                $('.block').click(function() {
                                    var id = this.id.split('-')[0]
                                    $('#' + id + '-hide').toggle()
                                    $('#' + id + '-show').toggle()
                                })
                            }
                        })
                })
            })
        </script>
        <h2><span id="Header"></span> <span id="Home"></span></h2>
        <h3>Input</h3>
        <div id="Input"></div>
        <h3>Output</h3>
        <div id="Output"></div>
        <h3>Description</h3>
        <div id="Description"></div>

        <table id="Fields">
        

        </table>
        <button id="Submit" type="button">Submit</button>
        <pre id="PrettyPrintJsonOutput"></pre>
    </body>
</html>
